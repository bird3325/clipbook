console.log("ClipBook Content Script Loaded (ì½˜í…ì¸  ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨)");const d=()=>{var e,t;try{return!!((e=chrome.runtime)!=null&&e.id&&((t=chrome.storage)!=null&&t.local))}catch{return!1}};document.addEventListener("mouseup",()=>{try{if(!d())return;const e=window.getSelection(),t=e==null?void 0:e.toString().trim(),n=document.getElementById("clipbook-capture-btn");n&&n.remove(),t&&t.length>0&&chrome.storage.local.get(["showFloatingButton"],i=>{try{if(!d()||!(i.showFloatingButton!==!1))return;if(e&&e.rangeCount>0){const l=e.getRangeAt(0).getBoundingClientRect(),o=document.createElement("button");o.id="clipbook-capture-btn",o.textContent="ClipBook ì €ìž¥",o.style.position="fixed",o.style.top=`${l.bottom+5}px`,o.style.left=`${l.left}px`,o.style.zIndex="999999",o.style.padding="8px 12px",o.style.background="#4361EE",o.style.color="#fff",o.style.border="none",o.style.borderRadius="4px",o.style.cursor="pointer",o.style.fontSize="12px",o.style.fontFamily="sans-serif",o.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",o.addEventListener("mousedown",g=>{try{if(g.preventDefault(),g.stopPropagation(),!d()){alert("í™•ìž¥ í”„ë¡œê·¸ëž¨ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. íŽ˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”."),o.remove();return}const u={id:Date.now().toString(),type:"text",text:t,sourceUrl:window.location.href,timestamp:Date.now()};chrome.storage.local.get(["clippings"],r=>{try{if(!d())return;const a=[...r.clippings||[],u];chrome.storage.local.set({clippings:a},()=>{try{if(!d())return;console.log("Saved via Floating Button"),h("ðŸ“ í…ìŠ¤íŠ¸ ì €ìž¥ ì™„ë£Œ!"),o.textContent="ì €ìž¥ ì™„ë£Œ!",o.style.background="#10B981",setTimeout(()=>{o.parentNode&&o.remove()},1500)}catch{}})}catch{}})}catch(u){console.debug("ClipBook: Error in button mousedown",u)}}),document.body.appendChild(o)}}catch(s){console.debug("ClipBook: Error in storage callback",s)}})}catch(e){String(e).includes("context invalidated")?console.debug("ClipBook: Extension context invalidated."):console.error("ClipBook mouseup Error:",e)}});chrome.runtime.onMessage.addListener((e,t,n)=>{var i;try{if(!d())return!1;if(e.action==="GET_SELECTION"){const s=((i=window.getSelection())==null?void 0:i.toString())||"";n({text:s})}return e.action==="START_REGION_CAPTURE"&&(x(),n({success:!0})),!0}catch(s){return console.debug("ClipBook: Error in message handler",s),!1}});const x=()=>{const e=document.createElement("div");e.id="clipbook-capture-overlay",Object.assign(e.style,{position:"fixed",top:"0",left:"0",width:"100vw",height:"100vh",backgroundColor:"rgba(0, 0, 0, 0.3)",zIndex:"9999999",cursor:"crosshair"});const t=document.createElement("div");Object.assign(t.style,{position:"absolute",border:"2px solid #4361EE",backgroundColor:"rgba(67, 97, 238, 0.1)",display:"none",pointerEvents:"none"}),e.appendChild(t);let n=0,i=0,s=!1;const p=r=>{s=!0,n=r.clientX,i=r.clientY,t.style.display="block",t.style.left=`${n}px`,t.style.top=`${i}px`,t.style.width="0px",t.style.height="0px"},l=r=>{if(!s)return;const c=r.clientX,a=r.clientY,m=Math.min(n,c),y=Math.min(i,a),w=Math.abs(n-c),f=Math.abs(i-a);t.style.left=`${m}px`,t.style.top=`${y}px`,t.style.width=`${w}px`,t.style.height=`${f}px`},o=async r=>{if(!s)return;s=!1;const c=t.getBoundingClientRect();e.remove(),!(c.width<5||c.height<5)&&setTimeout(()=>{chrome.runtime.sendMessage({action:"CAPTURE_VISIBLE_TAB"},a=>{a&&a.success&&a.dataUrl&&b(a.dataUrl,c)})},100)};e.addEventListener("mousedown",p),window.addEventListener("mousemove",l),window.addEventListener("mouseup",o),document.body.appendChild(e);const g=r=>{r.key==="Escape"&&(e.remove(),u())};window.addEventListener("keydown",g);const u=()=>{window.removeEventListener("mousemove",l),window.removeEventListener("mouseup",o),window.removeEventListener("keydown",g)}},b=(e,t)=>{const n=new Image;n.onload=()=>{const i=window.devicePixelRatio||1,s=document.createElement("canvas");s.width=t.width,s.height=t.height;const p=s.getContext("2d");if(p){p.drawImage(n,t.left*i,t.top*i,t.width*i,t.height*i,0,0,t.width,t.height);const l=s.toDataURL("image/png");v(l)}},n.src=e},v=e=>{const t={id:Date.now().toString(),type:"image",text:"Captured Image",imageData:e,sourceUrl:window.location.href,timestamp:Date.now()};chrome.storage.local.get(["clippings"],n=>{const i=n.clippings||[];chrome.storage.local.set({clippings:[...i,t]},()=>{console.log("Image saved via Region Capture"),h("ðŸ“¸ ì´ë¯¸ì§€ ìˆ˜ì§‘ ì™„ë£Œ!")})})},h=e=>{const t=document.createElement("div");t.textContent=e,Object.assign(t.style,{position:"fixed",top:"20px",left:"50%",transform:"translateX(-50%)",backgroundColor:"#4361EE",color:"white",padding:"12px 24px",borderRadius:"12px",fontSize:"14px",fontWeight:"bold",zIndex:"99999999",boxShadow:"0 4px 12px rgba(0,0,0,0.15)",transition:"all 0.3s ease",opacity:"0"}),document.body.appendChild(t),setTimeout(()=>{t.style.opacity="1",t.style.top="30px"},10),setTimeout(()=>{t.style.opacity="0",t.style.top="20px",setTimeout(()=>t.remove(),300)},2500)};document.addEventListener("mousedown",e=>{try{if(e.target.id!=="clipbook-capture-btn"){const n=document.getElementById("clipbook-capture-btn");n&&n.remove()}}catch{}});
