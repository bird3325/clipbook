console.log("ClipBook Content Script Loaded (콘텐츠 스크립트 로드됨)");const r=()=>{var t,o;try{return!!((t=chrome.runtime)!=null&&t.id&&((o=chrome.storage)!=null&&o.local))}catch{return!1}};document.addEventListener("mouseup",()=>{try{if(!r())return;const t=window.getSelection(),o=t==null?void 0:t.toString().trim(),n=document.getElementById("clipbook-capture-btn");n&&n.remove(),o&&o.length>0&&chrome.storage.local.get(["showFloatingButton"],i=>{if(!(!r()||!(i.showFloatingButton!==!1))&&t&&t.rangeCount>0){const c=t.getRangeAt(0).getBoundingClientRect(),e=document.createElement("button");e.id="clipbook-capture-btn",e.textContent="ClipBook 저장",e.style.position="fixed",e.style.top=`${c.bottom+5}px`,e.style.left=`${c.left}px`,e.style.zIndex="999999",e.style.padding="8px 12px",e.style.background="#4361EE",e.style.color="#fff",e.style.border="none",e.style.borderRadius="4px",e.style.cursor="pointer",e.style.fontSize="12px",e.style.fontFamily="sans-serif",e.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",e.addEventListener("mousedown",a=>{if(a.preventDefault(),a.stopPropagation(),!r()){alert("확장 프로그램이 업데이트되었습니다. 페이지를 새로고침해주세요."),e.remove();return}const d={id:Date.now().toString(),text:o,sourceUrl:window.location.href,timestamp:Date.now()};try{chrome.storage.local.get(["clippings"],l=>{if(!r())return;if(chrome.runtime.lastError){console.error("Storage error:",chrome.runtime.lastError);return}const u=[...l.clippings||[],d];chrome.storage.local.set({clippings:u},()=>{if(r()){if(chrome.runtime.lastError){console.error("Storage set error:",chrome.runtime.lastError);return}console.log("Saved via Floating Button (플로팅 버튼으로 저장됨)"),e.textContent="저장 완료!",e.style.background="#10B981",setTimeout(()=>{e.parentNode&&e.remove()},1500)}})})}catch(l){console.error("Context invalidation error during save:",l)}}),document.body.appendChild(e)}})}catch(t){String(t).includes("context invalidated")?console.debug("ClipBook: Extension context invalidated, skipping UI update."):console.error("ClipBook Error:",t)}});chrome.runtime.onMessage.addListener((t,o,n)=>{var i;try{if(!r()){console.debug("ClipBook: Context invalidated in message listener.");return}if(t.action==="GET_SELECTION"){const s=((i=window.getSelection())==null?void 0:i.toString())||"";n({text:s})}}catch(s){console.error("Error in content script message handler:",s)}return!0});document.addEventListener("mousedown",t=>{if(t.target.id!=="clipbook-capture-btn"){const n=document.getElementById("clipbook-capture-btn");n&&n.remove()}});
