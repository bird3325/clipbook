console.log("ClipBook Background Service Started (í´ë¦½ë¶ ë°±ê·¸ë¼ìš´ë“œ ì„œë¹„ìŠ¤ ì‹œìž‘)");chrome.runtime.onInstalled.addListener(()=>{console.log("ClipBook AI Extension installed (ì„¤ì¹˜ ì™„ë£Œ)"),chrome.contextMenus.create({id:"save-clip",title:"ClipBookì— ì €ìž¥ (Save to ClipBook)",contexts:["selection"]})});chrome.contextMenus.onClicked.addListener((i,u)=>{if(i.menuItemId==="save-clip"&&i.selectionText){console.log("Saving selection (ì„ íƒ ë‚´ìš© ì €ìž¥):",i.selectionText);const a={id:Date.now().toString(),text:i.selectionText,sourceUrl:(u==null?void 0:u.url)||"",timestamp:Date.now()};chrome.storage.local.get(["clippings"],r=>{const p=[...r.clippings||[],a];chrome.storage.local.set({clippings:p},()=>{console.log("Selection saved to storage (ìŠ¤í† ë¦¬ì§€ ì €ìž¥ ì™„ë£Œ)")})})}});chrome.runtime.onMessage.addListener((i,u,a)=>{if(i.action==="SAVE_TO_NOTION"){const{token:r,databaseId:m,title:p,content:f,url:x,mode:E,clippings:T}=i.data,_=(c=>{const o=c.trim(),n=/[a-f0-9]{32}/i,l=o.match(n);if(l)return l[0];if(o.includes("-")){const h=/[a-f0-9]{8}-?[a-f0-9]{4}-?[a-f0-9]{4}-?[a-f0-9]{4}-?[a-f0-9]{12}/i,t=o.match(h);if(t)return t[0].replace(/-/g,"")}return o})(m),v=(c,o,n,l)=>{const h=c.split(`
`),t=[];n&&(t.push({object:"block",type:"bookmark",bookmark:{url:n}}),t.push({object:"block",type:"divider",divider:{}}));let g=[];const s=()=>{g.length>0&&(g.forEach(b=>t.push(b)),g=[])};return h.forEach(b=>{const e=b.trim();if(!e){s();return}if(e.startsWith("### "))s(),t.push({object:"block",type:"heading_3",heading_3:{rich_text:[{type:"text",text:{content:e.replace("### ","")}}]}});else if(e.startsWith("## ")){s();const d=e.replace("## ","");o==="NOTION"&&(d.includes("ì¸ì‚¬ì´íŠ¸")||d.includes("Insight"))?t.push({object:"block",type:"callout",callout:{icon:{type:"emoji",emoji:"ðŸ’¡"},color:"blue_background",rich_text:[{type:"text",text:{content:d}}]}}):t.push({object:"block",type:"heading_2",heading_2:{rich_text:[{type:"text",text:{content:d}}]}})}else e.startsWith("# ")?(s(),t.push({object:"block",type:"heading_1",heading_1:{rich_text:[{type:"text",text:{content:e.replace("# ","")}}]}})):e.startsWith("- ")||e.startsWith("* ")?g.push({object:"block",type:"bulleted_list_item",bulleted_list_item:{rich_text:[{type:"text",text:{content:e.replace(/^[-*]\s/,"")}}]}}):e.startsWith("> ")?(s(),t.push({object:"block",type:"quote",quote:{rich_text:[{type:"text",text:{content:e.replace("> ","")}}]}})):e.startsWith("- [ ] ")||e.startsWith("- [x] ")?(s(),t.push({object:"block",type:"to_do",to_do:{checked:e.startsWith("- [x] "),rich_text:[{type:"text",text:{content:e.replace(/- \[[ x]\] /,"")}}]}})):e.includes("[IMAGE_ID:")?(s(),e.split(/(\[IMAGE_ID:\s*\d+\])/).forEach(y=>{const k=y.match(/\[IMAGE_ID:\s*(\d+)\]/);if(k){const I=k[1],j=l.find(D=>D.id===I);j&&j.imageData&&t.push({object:"block",type:"callout",callout:{icon:{type:"emoji",emoji:"ðŸ–¼ï¸"},rich_text:[{type:"text",text:{content:`ìˆ˜ì§‘ëœ ì´ë¯¸ì§€ (ID: ${I})`}}]}})}else y.trim()&&t.push({object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:y.trim()}}]}})})):(s(),t.push({object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:e}}]}}))}),s(),t.push({object:"block",type:"divider",divider:{}}),t.push({object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:`Generated by ClipBook AI (${o} Mode)`},annotations:{italic:!0,color:"gray"}}]}}),t.slice(0,100)};return fetch(`https://api.notion.com/v1/databases/${_}`,{method:"GET",headers:{Authorization:`Bearer ${r}`,"Notion-Version":"2022-06-28"}}).then(async c=>{const o=await c.json();if(!c.ok){let t=o.message||c.statusText;throw o.code==="object_not_found"?t="ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (IDê°€ ì •í™•í•œì§€, í†µí•© ê¸°ëŠ¥ì´ ê³µìœ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”)":o.code==="unauthorized"?t="í† í°ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.":(o.code==="restricted_resource"||c.status===403)&&(t="ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (í†µí•© ê¸°ëŠ¥ ê³µìœ  ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”)"),new Error(t)}let n="title";const l=o.properties;for(const t in l)if(l[t].type==="title"){n=t;break}const h=v(f,E,x,T);return fetch("https://api.notion.com/v1/pages",{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json","Notion-Version":"2022-06-28"},body:JSON.stringify({parent:{database_id:_},properties:{[n]:{title:[{text:{content:p}}]}},children:h})})}).then(async c=>{if(c instanceof Response){const o=await c.json();if(!c.ok)throw new Error(o.message||"íŽ˜ì´ì§€ ìƒì„± ì‹¤íŒ¨");a({success:!0,data:o})}}).catch(c=>{console.error("Notion Error:",c),a({success:!1,error:c.message})}),!0}if(i.action==="DOWNLOAD_FILE"){const{base64:r,url:m,filename:p}=i.data;let f=m;return r&&(f=`data:application/pdf;base64,${r}`),chrome.downloads.download({url:f,filename:p,saveAs:!0},x=>{chrome.runtime.lastError?a({success:!1,error:chrome.runtime.lastError.message}):a({success:!0,downloadId:x})}),!0}if(i.action==="CAPTURE_VISIBLE_TAB")return chrome.tabs.captureVisibleTab(void 0,{format:"png"},r=>{chrome.runtime.lastError?a({success:!1,error:chrome.runtime.lastError.message}):a({success:!0,dataUrl:r})}),!0});
