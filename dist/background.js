console.log("ClipBook Background Service Started (í´ë¦½ë¶ ë°±ê·¸ë¼ìš´ë“œ ì„œë¹„ìŠ¤ ì‹œìž‘)");chrome.runtime.onInstalled.addListener(()=>{console.log("ClipBook AI Extension installed (ì„¤ì¹˜ ì™„ë£Œ)"),chrome.contextMenus.create({id:"save-clip",title:"ClipBookì— ì €ìž¥ (Save to ClipBook)",contexts:["selection"]})});chrome.contextMenus.onClicked.addListener((i,m)=>{if(i.menuItemId==="save-clip"&&i.selectionText){console.log("Saving selection (ì„ íƒ ë‚´ìš© ì €ìž¥):",i.selectionText);const h={id:Date.now().toString(),text:i.selectionText,sourceUrl:(m==null?void 0:m.url)||"",timestamp:Date.now()};chrome.storage.local.get(["clippings"],n=>{const b=[...n.clippings||[],h];chrome.storage.local.set({clippings:b},()=>{console.log("Selection saved to storage (ìŠ¤í† ë¦¬ì§€ ì €ìž¥ ì™„ë£Œ)")})})}});chrome.runtime.onMessage.addListener((i,m,h)=>{if(i.action==="SAVE_TO_NOTION"){const{token:n,databaseId:f,title:b,content:d,url:a,mode:g}=i.data,x=(r=>{const o=r.trim(),l=/[a-f0-9]{32}/i,p=o.match(l);if(p)return p[0];if(o.includes("-")){const t=/[a-f0-9]{8}-?[a-f0-9]{4}-?[a-f0-9]{4}-?[a-f0-9]{4}-?[a-f0-9]{12}/i,c=o.match(t);if(c)return c[0].replace(/-/g,"")}return o})(f),u=(r,o,l)=>{const p=r.split(`
`),t=[];l&&(t.push({object:"block",type:"bookmark",bookmark:{url:l}}),t.push({object:"block",type:"divider",divider:{}}));let c=[];const s=()=>{c.length>0&&(c.forEach(k=>t.push(k)),c=[])};return p.forEach(k=>{const e=k.trim();if(!e){s();return}if(e.startsWith("### "))s(),t.push({object:"block",type:"heading_3",heading_3:{rich_text:[{type:"text",text:{content:e.replace("### ","")}}]}});else if(e.startsWith("## ")){s();const y=e.replace("## ","");o==="NOTION"&&(y.includes("ì¸ì‚¬ì´íŠ¸")||y.includes("Insight"))?t.push({object:"block",type:"callout",callout:{icon:{type:"emoji",emoji:"ðŸ’¡"},color:"blue_background",rich_text:[{type:"text",text:{content:y}}]}}):t.push({object:"block",type:"heading_2",heading_2:{rich_text:[{type:"text",text:{content:y}}]}})}else e.startsWith("# ")?(s(),t.push({object:"block",type:"heading_1",heading_1:{rich_text:[{type:"text",text:{content:e.replace("# ","")}}]}})):e.startsWith("- ")||e.startsWith("* ")?c.push({object:"block",type:"bulleted_list_item",bulleted_list_item:{rich_text:[{type:"text",text:{content:e.replace(/^[-*]\s/,"")}}]}}):e.startsWith("> ")?(s(),t.push({object:"block",type:"quote",quote:{rich_text:[{type:"text",text:{content:e.replace("> ","")}}]}})):e.startsWith("- [ ] ")||e.startsWith("- [x] ")?(s(),t.push({object:"block",type:"to_do",to_do:{checked:e.startsWith("- [x] "),rich_text:[{type:"text",text:{content:e.replace(/- \[[ x]\] /,"")}}]}})):(s(),t.push({object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:e}}]}}))}),s(),t.push({object:"block",type:"divider",divider:{}}),t.push({object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:`Generated by ClipBook AI (${o} Mode)`},annotations:{italic:!0,color:"gray"}}]}}),t.slice(0,100)};return fetch(`https://api.notion.com/v1/databases/${x}`,{method:"GET",headers:{Authorization:`Bearer ${n}`,"Notion-Version":"2022-06-28"}}).then(async r=>{const o=await r.json();if(!r.ok){let c=o.message||r.statusText;throw o.code==="object_not_found"?c="ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (IDê°€ ì •í™•í•œì§€, í†µí•© ê¸°ëŠ¥ì´ ê³µìœ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”)":o.code==="unauthorized"?c="í† í°ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.":(o.code==="restricted_resource"||r.status===403)&&(c="ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (í†µí•© ê¸°ëŠ¥ ê³µìœ  ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”)"),new Error(c)}let l="title";const p=o.properties;for(const c in p)if(p[c].type==="title"){l=c;break}const t=u(d,g,a);return fetch("https://api.notion.com/v1/pages",{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json","Notion-Version":"2022-06-28"},body:JSON.stringify({parent:{database_id:x},properties:{[l]:{title:[{text:{content:b}}]}},children:t})})}).then(async r=>{if(r instanceof Response){const o=await r.json();if(!r.ok)throw new Error(o.message||"íŽ˜ì´ì§€ ìƒì„± ì‹¤íŒ¨");h({success:!0,data:o})}}).catch(r=>{console.error("Notion Error:",r),h({success:!1,error:r.message})}),!0}if(i.action==="DOWNLOAD_FILE"){const{base64:n,url:f,filename:b}=i.data;let d=f;if(n){const a=atob(n),g=new Array(a.length);for(let u=0;u<a.length;u++)g[u]=a.charCodeAt(u);const _=new Uint8Array(g),x=new Blob([_],{type:"application/pdf"});d=URL.createObjectURL(x)}return chrome.downloads.download({url:d,filename:b,saveAs:!0},a=>{n&&d.startsWith("blob:")&&setTimeout(()=>URL.revokeObjectURL(d),6e4),chrome.runtime.lastError?h({success:!1,error:chrome.runtime.lastError.message}):h({success:!0,downloadId:a})}),!0}});
