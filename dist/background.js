console.log("ClipBook Background Service Started (í´ë¦½ë¶ ë°±ê·¸ë¼ìš´ë“œ ì„œë¹„ìŠ¤ ì‹œìž‘)");chrome.runtime.onInstalled.addListener(()=>{console.log("ClipBook AI Extension installed (ì„¤ì¹˜ ì™„ë£Œ)"),chrome.contextMenus.create({id:"save-clip",title:"ClipBookì— ì €ìž¥ (Save to ClipBook)",contexts:["selection"]})});chrome.contextMenus.onClicked.addListener((i,r)=>{if(i.menuItemId==="save-clip"&&i.selectionText){console.log("Saving selection (ì„ íƒ ë‚´ìš© ì €ìž¥):",i.selectionText);const a={id:Date.now().toString(),text:i.selectionText,sourceUrl:(r==null?void 0:r.url)||"",timestamp:Date.now()};chrome.storage.local.get(["clippings"],p=>{const h=[...p.clippings||[],a];chrome.storage.local.set({clippings:h},()=>{console.log("Selection saved to storage (ìŠ¤í† ë¦¬ì§€ ì €ìž¥ ì™„ë£Œ)")})})}});chrome.runtime.onMessage.addListener((i,r,a)=>{if(i.action==="SAVE_TO_NOTION"){const{token:p,databaseId:u,title:h,content:x,url:g,mode:_}=i.data,b=((o,n)=>{const y=o.split(`
`),e=[];let l=[];const c=()=>{l.length>0&&(l.forEach(d=>e.push(d)),l=[])};return y.forEach(d=>{const t=d.trim();if(!t){c();return}if(t.startsWith("### "))c(),e.push({object:"block",type:"heading_3",heading_3:{rich_text:[{type:"text",text:{content:t.replace("### ","")}}]}});else if(t.startsWith("## ")){c();const s=t.replace("## ","");n==="NOTION"&&(s.includes("ì¸ì‚¬ì´íŠ¸")||s.includes("Insight"))?e.push({object:"block",type:"callout",callout:{icon:{type:"emoji",emoji:"ðŸ’¡"},color:"blue_background",rich_text:[{type:"text",text:{content:s}}]}}):e.push({object:"block",type:"heading_2",heading_2:{rich_text:[{type:"text",text:{content:s}}]}})}else if(t.startsWith("# "))c(),e.push({object:"block",type:"heading_1",heading_1:{rich_text:[{type:"text",text:{content:t.replace("# ","")}}]}});else if(t.startsWith("- ")||t.startsWith("* ")){const s=t.replace(/^[-*]\s/,"");n==="CARD"||n==="REPORT"?l.push({object:"block",type:"bulleted_list_item",bulleted_list_item:{rich_text:[{type:"text",text:{content:s}}]}}):l.push({object:"block",type:"bulleted_list_item",bulleted_list_item:{rich_text:[{type:"text",text:{content:s}}]}})}else t.startsWith("> ")?(c(),e.push({object:"block",type:"quote",quote:{rich_text:[{type:"text",text:{content:t.replace("> ","")}}]}})):t.startsWith("- [ ] ")||t.startsWith("- [x] ")?(c(),e.push({object:"block",type:"to_do",to_do:{checked:t.startsWith("- [x] "),rich_text:[{type:"text",text:{content:t.replace(/- \[[ x]\] /,"")}}]}})):(c(),e.push({object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:t}}]}}))}),c(),e.push({object:"block",type:"divider",divider:{}}),e.push({object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:`Generated by ClipBook AI (${n} Mode)`},annotations:{italic:!0,color:"gray"}}]}}),e.slice(0,100)})(x,_);return fetch("https://api.notion.com/v1/pages",{method:"POST",headers:{Authorization:`Bearer ${p}`,"Content-Type":"application/json","Notion-Version":"2022-06-28"},body:JSON.stringify({parent:{database_id:u},properties:{title:{title:[{text:{content:h}}]},URL:{url:g}},children:b})}).then(o=>o.ok?o.json():o.json().then(n=>{throw new Error(n.message||o.statusText)})).then(o=>a({success:!0,data:o})).catch(o=>a({success:!1,error:o.message})),!0}});
