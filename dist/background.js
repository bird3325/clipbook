console.log("ClipBook Background Service Started (í´ë¦½ë¶ ë°±ê·¸ë¼ìš´ë“œ ì„œë¹„ìŠ¤ ì‹œìž‘)");chrome.runtime.onInstalled.addListener(()=>{console.log("ClipBook AI Extension installed (ì„¤ì¹˜ ì™„ë£Œ)"),chrome.contextMenus.create({id:"save-clip",title:"ClipBookì— ì €ìž¥ (Save to ClipBook)",contexts:["selection"]})});chrome.contextMenus.onClicked.addListener((s,p)=>{if(s.menuItemId==="save-clip"&&s.selectionText){console.log("Saving selection (ì„ íƒ ë‚´ìš© ì €ìž¥):",s.selectionText);const n={id:Date.now().toString(),text:s.selectionText,sourceUrl:(p==null?void 0:p.url)||"",timestamp:Date.now()};chrome.storage.local.get(["clippings"],l=>{const a=[...l.clippings||[],n];chrome.storage.local.set({clippings:a},()=>{console.log("Selection saved to storage (ìŠ¤í† ë¦¬ì§€ ì €ìž¥ ì™„ë£Œ)")})})}});chrome.runtime.onMessage.addListener((s,p,n)=>{if(s.action==="SAVE_TO_NOTION"){const{token:l,databaseId:h,title:a,content:g,url:b,mode:m}=s.data,k=(e=>{if(e.includes("/")){const c=e.split("/");return c[c.length-1].split("?")[0]}return e.trim()})(h),y=((e,c,r)=>{const _=e.split(`
`),o=[];r&&(o.push({object:"block",type:"bookmark",bookmark:{url:r}}),o.push({object:"block",type:"divider",divider:{}}));let d=[];const i=()=>{d.length>0&&(d.forEach(x=>o.push(x)),d=[])};return _.forEach(x=>{const t=x.trim();if(!t){i();return}if(t.startsWith("### "))i(),o.push({object:"block",type:"heading_3",heading_3:{rich_text:[{type:"text",text:{content:t.replace("### ","")}}]}});else if(t.startsWith("## ")){i();const u=t.replace("## ","");c==="NOTION"&&(u.includes("ì¸ì‚¬ì´íŠ¸")||u.includes("Insight"))?o.push({object:"block",type:"callout",callout:{icon:{type:"emoji",emoji:"ðŸ’¡"},color:"blue_background",rich_text:[{type:"text",text:{content:u}}]}}):o.push({object:"block",type:"heading_2",heading_2:{rich_text:[{type:"text",text:{content:u}}]}})}else t.startsWith("# ")?(i(),o.push({object:"block",type:"heading_1",heading_1:{rich_text:[{type:"text",text:{content:t.replace("# ","")}}]}})):t.startsWith("- ")||t.startsWith("* ")?d.push({object:"block",type:"bulleted_list_item",bulleted_list_item:{rich_text:[{type:"text",text:{content:t.replace(/^[-*]\s/,"")}}]}}):t.startsWith("> ")?(i(),o.push({object:"block",type:"quote",quote:{rich_text:[{type:"text",text:{content:t.replace("> ","")}}]}})):t.startsWith("- [ ] ")||t.startsWith("- [x] ")?(i(),o.push({object:"block",type:"to_do",to_do:{checked:t.startsWith("- [x] "),rich_text:[{type:"text",text:{content:t.replace(/- \[[ x]\] /,"")}}]}})):(i(),o.push({object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:t}}]}}))}),i(),o.push({object:"block",type:"divider",divider:{}}),o.push({object:"block",type:"paragraph",paragraph:{rich_text:[{type:"text",text:{content:`Generated by ClipBook AI (${c} Mode)`},annotations:{italic:!0,color:"gray"}}]}}),o.slice(0,100)})(g,m,b);return fetch("https://api.notion.com/v1/pages",{method:"POST",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json","Notion-Version":"2022-06-28"},body:JSON.stringify({parent:{database_id:k},properties:{title:{title:[{text:{content:a}}]}},children:y})}).then(async e=>{const c=await e.json();if(!e.ok){let r=c.message||e.statusText;throw c.code==="object_not_found"?r="ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ID í™•ì¸ ë° í†µí•© ê¸°ëŠ¥ ê³µìœ  ì—¬ë¶€ í™•ì¸ í•„ìš”)":c.code==="unauthorized"&&(r="í† í°ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."),new Error(r)}return c}).then(e=>n({success:!0,data:e})).catch(e=>n({success:!1,error:e.message})),!0}if(s.action==="DOWNLOAD_FILE"){const{url:l,filename:h}=s.data;return chrome.downloads.download({url:l,filename:h,saveAs:!0},a=>{chrome.runtime.lastError?n({success:!1,error:chrome.runtime.lastError.message}):n({success:!0,downloadId:a})}),!0}});
