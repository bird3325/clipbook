
import { GoogleGenAI } from "@google/genai";
import { SummaryMode, Clipping } from "../types";

export const generateAIContent = async (
  mode: SummaryMode,
  clippings: Clipping[],
  customInstruction: string = "",
  apiKey?: string
): Promise<string> => {
  // ì‚¬ìš©ìê°€ ì…ë ¥í•œ í‚¤ê°€ ì—†ìœ¼ë©´ í™˜ê²½ë³€ìˆ˜ ì‚¬ìš© (ê°œë°œìš©)
  const finalApiKey = apiKey || process.env.API_KEY || "";

  if (!finalApiKey) {
    throw new Error("API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
  }

  // í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” (ìƒˆë¡œìš´ SDK)
  const client = new GoogleGenAI({ apiKey: finalApiKey });

  // í…ìŠ¤íŠ¸ ì¡°í•© (ì¶œì²˜ ë° ì‹œê°„ ì •ë³´ í¬í•¨)
  const contentToAnalyze = clippings.map(c =>
    `[ë°œì·Œ ì›ë¬¸]: ${c.text}\n[ì¶œì²˜]: ${c.sourceUrl}\n[ìˆ˜ì§‘ ì‹œê°]: ${new Date(c.timestamp).toLocaleString()}`
  ).join("\n\n---\n\n");

  // ëª¨ë“œë³„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„¸í™”
  const systemInstructions = {
    [SummaryMode.REPORT]: `
      ë‹¹ì‹ ì€ ì „ë¬¸ ë¦¬ì„œì¹˜ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì œê³µëœ í…ìŠ¤íŠ¸ë“¤ì„ ë°”íƒ•ìœ¼ë¡œ ê³µì‹ ë³´ê³ ì„œ ì´ˆì•ˆì„ ì‘ì„±í•˜ì„¸ìš”.
      
      [í•„ìˆ˜ í˜•ì‹]
      1. ì œëª©: (í•µì‹¬ ë‚´ìš©ì„ ê´€í†µí•˜ëŠ” ì œëª©)
      2. ë°°ê²½: (ì´ ì£¼ì œê°€ ì™œ ì¤‘ìš”í•œì§€, ë¬¸ë§¥ ì„¤ëª…)
      3. ì£¼ìš” ë‚´ìš©/ë¬¸ì œ: (ë°œì·Œëœ í…ìŠ¤íŠ¸ì˜ í•µì‹¬ ë¶„ì„)
      4. í•´ê²°ë°©í–¥/ì œì–¸: (ë‚´ìš©ì— ê¸°ë°˜í•œ í†µì°°)
      5. ê²°ë¡ : (í•œ ì¤„ ìš”ì•½)
      6. ì°¸ê³ ìë£Œ: (ì›ë³¸ ë§í¬ ëª©ë¡)
      
      í†¤ì•¤ë§¤ë„ˆ: ê°ê´€ì , ë¶„ì„ì , ì „ë¬¸ì .
    `,
    [SummaryMode.EMAIL]: `
      ë‹¹ì‹ ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ í…ìŠ¤íŠ¸ë“¤ì„ ë°”íƒ•ìœ¼ë¡œ ì—…ë¬´ìš© ì´ë©”ì¼ ì´ˆì•ˆì„ ì‘ì„±í•˜ì„¸ìš”.
      
      [í•„ìˆ˜ í˜•ì‹]
      1. ì œëª©: (ìˆ˜ì‹ ìê°€ í´ë¦­í•˜ê³  ì‹¶ì€ ëª…í™•í•œ ì œëª©)
      2. ë„ì…ë¶€: (ì •ì¤‘í•œ ì¸ì‚¬ ë° ë©”ì¼ ëª©ì )
      3. í•µì‹¬ ìš”ì•½: (ë°œì·Œ ë‚´ìš©ì˜ ìš”ì  ì •ë¦¬ - ê¸€ë¨¸ë¦¬ ê¸°í˜¸ ì‚¬ìš©)
      4. ìš”ì²­/ì œì•ˆ ì‚¬í•­: (ëª…í™•í•œ Action Item)
      5. ë§ºìŒë§: (ì¶”í›„ ì¼ì • ì–¸ê¸‰ ë° ì •ì¤‘í•œ ë§ˆë¬´ë¦¬)
      
      í†¤ì•¤ë§¤ë„ˆ: ì •ì¤‘í•¨, ëª…ë£Œí•¨, ë¹„ì¦ˆë‹ˆìŠ¤ ê²©ì‹.
    `,
    [SummaryMode.NOTION]: `
      ë‹¹ì‹ ì€ ì§€ì‹ ê´€ë¦¬(PKM) ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ í…ìŠ¤íŠ¸ë¥¼ ë…¸ì…˜(Notion)ì— ì €ì¥í•˜ê¸° ì¢‹ì€ êµ¬ì¡°í™”ëœ ë…¸íŠ¸ë¡œ ë³€í™˜í•˜ì„¸ìš”.
      
      [í•„ìˆ˜ í˜•ì‹ - ë§ˆí¬ë‹¤ìš´]
      # (ì§ê´€ì ì¸ ì œëª©)
      
      ## ğŸ’¡ í•µì‹¬ ì¸ì‚¬ì´íŠ¸
      (ë‚´ìš©ì˜ ë³¸ì§ˆì ì¸ ì˜ë¯¸ë‚˜ í†µì°° 1-2ë¬¸ì¥)
      
      ## ğŸ“ ìƒì„¸ ìš”ì•½
      - (ì£¼ìš” í¬ì¸íŠ¸ 1)
      - (ì£¼ìš” í¬ì¸íŠ¸ 2)
      
      ## âœ… Action Item / ì ìš©ì 
      - [ ] (ì‹¤ì²œ ê°€ëŠ¥í•œ í•­ëª© 1)
      
      > [ì¶œì²˜ ë° íƒœê·¸]
      > #íƒœê·¸1 #íƒœê·¸2
      
      í†¤ì•¤ë§¤ë„ˆ: ì§ê´€ì , êµ¬ì¡°ì , í•µì‹¬ ìœ„ì£¼.
    `,
    [SummaryMode.CARD]: `
      ë‹¹ì‹ ì€ ì½˜í…ì¸  íë ˆì´í„°ì…ë‹ˆë‹¤. ì†Œì…œ ë¯¸ë””ì–´(LinkedIn, Twitter)ë‚˜ ì¹´ë“œ ë‰´ìŠ¤ì— ì í•©í•œ í˜•íƒœë¡œ ìš”ì•½í•˜ì„¸ìš”.
      
      [í•„ìˆ˜ í˜•ì‹]
      1. ìºì¹˜í”„ë ˆì´ì¦ˆ (ì‹œì„ ì„ ë„ëŠ” í•œ ë¬¸ì¥)
      2. 3ì¤„ ìš”ì•½ (ì´ëª¨ì§€ í™œìš©)
      3. ì›ë¬¸ ë§í¬
      
      í†¤ì•¤ë§¤ë„ˆ: íŠ¸ë Œë””, ê°„ê²°í•¨, ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš©.
    `
  };

  const userPrompt = `
    ë‹¤ìŒì€ ì‚¬ìš©ìê°€ ì›¹ì—ì„œ ìˆ˜ì§‘í•œ í…ìŠ¤íŠ¸ ì¡°ê°ë“¤ì…ë‹ˆë‹¤.
    
    ${contentToAnalyze}
    
    ---------------------------------------------------
    
    [ì‚¬ìš©ì ì¶”ê°€ ì§€ì‹œì‚¬í•­]
    ${customInstruction ? customInstruction : "íŠ¹ë³„í•œ ì¶”ê°€ ì§€ì‹œëŠ” ì—†ìŠµë‹ˆë‹¤. ìœ„ ì„¤ì •ëœ í˜ë¥´ì†Œë‚˜ì™€ í˜•ì‹ì— ì¶©ì‹¤í•´ ì£¼ì„¸ìš”."}
    
    ìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì„ íƒëœ ëª¨ë“œ(${mode})ì˜ í˜•ì‹ì— ë§ì¶° í•œêµ­ì–´ë¡œ ë‹µë³€í•´ ì£¼ì„¸ìš”.
  `;

  try {
    const response = await client.models.generateContent({
      model: 'gemini-1.5-flash', // ëª¨ë¸ëª… ìˆ˜ì •
      contents: [
        {
          role: 'user',
          parts: [
            { text: systemInstructions[mode] }, // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ user ë©”ì‹œì§€ì˜ ì¼ë¶€ë¡œ í¬í•¨ (SDK ë²„ì „ì— ë”°ë¼ systemInstruction ë³„ë„ í•„ë“œ ì§€ì› ì—¬ë¶€ í™•ì¸ í•„ìš”í•˜ë‚˜, ì•ˆì „í•˜ê²Œ í…ìŠ¤íŠ¸ë¡œ ë³‘í•©)
            { text: userPrompt }
          ]
        }
      ],
      config: {
        temperature: 0.7,
      },
    });

    return response.text || "ì •ë¦¬ëœ ë‚´ìš©ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
  } catch (error) {
    console.error("AI Generation Error:", error);
    throw new Error("AI ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. API í‚¤ë‚˜ ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
  }
};
